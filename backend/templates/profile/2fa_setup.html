{% extends "base.html" %}
{% block title %}{{ _("Set Up Two-Factor Authentication") }} - OpenDLP{% endblock %}
{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h1 class="govuk-heading-xl">{{ _("Set Up Two-Factor Authentication") }}</h1>
            <h2 class="govuk-heading-m">{{ _("Step 1: Scan QR Code") }}</h2>
            <p class="govuk-body">
                {{ _("Open your authenticator app and scan this QR code:") }}
            </p>
            <div class="govuk-!-margin-bottom-6">
                <img src="{{ qr_code_url }}"
                    alt="{{ _('QR code for two-factor authentication setup') }}"
                    style="max-width: 300px;
                        border: 1px solid #b1b4b6;
                        padding: 20px;
                        background: white" />
            </div>
            <details class="govuk-details govuk-!-margin-bottom-6">
                <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text">{{ _("Can't scan the QR code?") }}</span>
                </summary>
                <div class="govuk-details__text">
                    <p class="govuk-body">{{ _("You can enter this code manually in your authenticator app:") }}</p>
                    <div style="background: #f3f2f1;
                        padding: 15px;
                        border-left: 4px solid #1d70b8;
                        font-family: monospace;
                        font-size: 18px;
                        word-break: break-all">{{ totp_secret }}</div>
                </div>
            </details>
            <h2 class="govuk-heading-m">{{ _("Step 2: Save Backup Codes") }}</h2>
            <div class="govuk-warning-text">
                <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
                <strong class="govuk-warning-text__text">
                    <span class="govuk-warning-text__assistive">{{ _("Warning") }}</span>
                    {{ _("Save these backup codes in a safe place. Each code can only be used once. If you lose access to your authenticator app, you'll need these codes to sign in.") }}
                </strong>
            </div>
            <div style="background: #f3f2f1;
                padding: 20px;
                border: 1px solid #b1b4b6;
                margin-bottom: 30px">
                <div id="backup-codes"
                    style="display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 10px;
                        font-family: monospace;
                        font-size: 16px">
                    {% for code in backup_codes %}
                        <div>{{ code }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="govuk-button-group govuk-!-margin-bottom-6">
                <button onclick="downloadBackupCodes()"
                    class="govuk-button govuk-button--secondary"
                    data-module="govuk-button">{{ _("Download codes") }}</button>
                <button data-print
                    class="govuk-button govuk-button--secondary"
                    data-module="govuk-button">{{ _("Print codes") }}</button>
            </div>
            <h2 class="govuk-heading-m">{{ _("Step 3: Verify Setup") }}</h2>
            <p class="govuk-body">
                {{ _("Enter the 6-digit code from your authenticator app to complete setup:") }}
            </p>
            <form method="POST" action="{{ url_for('profile.enable_2fa') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="govuk-form-group">
                    <label class="govuk-label" for="totp_code">{{ _("Verification code") }}</label>
                    <input class="govuk-input govuk-input--width-10"
                        id="totp_code"
                        name="totp_code"
                        type="text"
                        inputmode="numeric"
                        pattern="[0-9]{6}"
                        maxlength="6"
                        autocomplete="one-time-code"
                        autofocus
                        required />
                </div>
                <div class="govuk-button-group">
                    <button type="submit" class="govuk-button" data-module="govuk-button">{{ _("Verify and enable") }}</button>
                    <a href="{{ url_for('profile.two_factor_settings') }}" class="govuk-link">{{ _("Cancel") }}</a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

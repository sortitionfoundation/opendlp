{% extends "base.html" %}
{% block title %}{{ _("My Account") }} - OpenDLP{% endblock %}
{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h1 class="govuk-heading-xl">{{ _("My Account") }}</h1>
            <h2 class="govuk-heading-m">{{ _("Profile Information") }}</h2>
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">{{ _("Email address") }}</dt>
                    <dd class="govuk-summary-list__value">
                        {{ current_user.email }}
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">{{ _("First Name") }}</dt>
                    <dd class="govuk-summary-list__value">
                        {{ current_user.first_name if current_user.first_name else _("Not set") }}
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">{{ _("Last Name") }}</dt>
                    <dd class="govuk-summary-list__value">
                        {{ current_user.last_name if current_user.last_name else _("Not set") }}
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">{{ _("Role") }}</dt>
                    <dd class="govuk-summary-list__value">
                        <strong class="govuk-tag govuk-tag--blue">{{ current_user.global_role.value }}</strong>
                    </dd>
                </div>
            </dl>
            <h2 class="govuk-heading-m govuk-!-margin-top-6">{{ _("Authentication Methods") }}</h2>
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">{{ _("Password") }}</dt>
                    <dd class="govuk-summary-list__value">
                        {% if current_user.password_hash %}
                            <strong class="govuk-tag govuk-tag--green">{{ _("Active") }}</strong>
                        {% else %}
                            <strong class="govuk-tag govuk-tag--grey">{{ _("Not set") }}</strong>
                        {% endif %}
                    </dd>
                    <dd class="govuk-summary-list__actions">
                        {% if current_user.password_hash and current_user.oauth_provider %}
                            <form method="POST"
                                action="{{ url_for('profile.remove_password') }}"
                                style="display: inline"
                                onsubmit="return confirm('{{ _("Are you sure you want to remove password authentication? You will only be able to sign in with Google.") }}');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                <button type="submit"
                                    class="govuk-link govuk-!-font-size-19"
                                    style="border: none;
                                        background: none;
                                        cursor: pointer;
                                        text-decoration: underline">{{ _("Remove") }}</button>
                            </form>
                        {% elif not current_user.password_hash %}
                            {% if current_user.oauth_provider %}
                                <a href="{{ url_for('profile.set_password') }}" class="govuk-link">{{ _("Set password") }}</a>
                            {% else %}
                                <span class="govuk-hint govuk-!-font-size-16">{{ _("No password set") }}</span>
                            {% endif %}
                        {% endif %}
                    </dd>
                </div>
                {% if config.OAUTH_GOOGLE_CLIENT_ID %}
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">{{ _("Google OAuth") }}</dt>
                        <dd class="govuk-summary-list__value">
                            {% if current_user.oauth_provider == 'google' %}
                                <strong class="govuk-tag govuk-tag--green">{{ _("Active") }}</strong>
                            {% else %}
                                <strong class="govuk-tag govuk-tag--grey">{{ _("Not linked") }}</strong>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            {% if current_user.oauth_provider == 'google' %}
                                {% if current_user.password_hash %}
                                    <form method="POST"
                                        action="{{ url_for('profile.remove_oauth') }}"
                                        style="display: inline"
                                        onsubmit="return confirm('{{ _("Are you sure you want to unlink your Google account? You will only be able to sign in with your password.") }}');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <button type="submit"
                                            class="govuk-link govuk-!-font-size-19"
                                            style="border: none;
                                                background: none;
                                                cursor: pointer;
                                                text-decoration: underline">{{ _("Unlink") }}</button>
                                    </form>
                                {% else %}
                                    <span class="govuk-hint govuk-!-font-size-16">{{ _("Only authentication method") }}</span>
                                {% endif %}
                            {% elif not current_user.oauth_provider and config.OAUTH_GOOGLE_CLIENT_ID %}
                                <a href="{{ url_for('profile.link_google') }}" class="govuk-link">{{ _("Link Google account") }}</a>
                            {% elif current_user.oauth_provider and current_user.oauth_provider != 'google' %}
                                <span class="govuk-hint govuk-!-font-size-16">{{ _("Remove %(provider)s first", provider=current_user.oauth_provider.title() ) }}</span>
                            {% endif %}
                        </dd>
                    </div>
                {% endif %}
                {% if config.OAUTH_MICROSOFT_CLIENT_ID %}
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">{{ _("Microsoft OAuth") }}</dt>
                        <dd class="govuk-summary-list__value">
                            {% if current_user.oauth_provider == 'microsoft' %}
                                <strong class="govuk-tag govuk-tag--green">{{ _("Active") }}</strong>
                            {% else %}
                                <strong class="govuk-tag govuk-tag--grey">{{ _("Not linked") }}</strong>
                            {% endif %}
                        </dd>
                        <dd class="govuk-summary-list__actions">
                            {% if current_user.oauth_provider == 'microsoft' %}
                                {% if current_user.password_hash %}
                                    <form method="POST"
                                        action="{{ url_for('profile.remove_oauth') }}"
                                        style="display: inline"
                                        onsubmit="return confirm('{{ _("Are you sure you want to unlink your Microsoft account? You will only be able to sign in with your password.") }}');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                                        <button type="submit"
                                            class="govuk-link govuk-!-font-size-19"
                                            style="border: none;
                                                background: none;
                                                cursor: pointer;
                                                text-decoration: underline">{{ _("Unlink") }}</button>
                                    </form>
                                {% else %}
                                    <span class="govuk-hint govuk-!-font-size-16">{{ _("Only authentication method") }}</span>
                                {% endif %}
                            {% elif not current_user.oauth_provider and config.OAUTH_MICROSOFT_CLIENT_ID %}
                                <a href="{{ url_for('profile.link_microsoft') }}" class="govuk-link">{{ _("Link Microsoft account") }}</a>
                            {% elif current_user.oauth_provider and current_user.oauth_provider != 'microsoft' %}
                                <span class="govuk-hint govuk-!-font-size-16">{{ _("Remove %(provider)s first", provider=current_user.oauth_provider.title() ) }}</span>
                            {% endif %}
                        </dd>
                    </div>
                {% endif %}
            </dl>
            <div class="govuk-button-group">
                <a href="{{ url_for('profile.edit') }}"
                    class="govuk-button govuk-button--secondary"
                    data-module="govuk-button">{{ _("Edit profile") }}</a>
                {% if current_user.password_hash %}
                    <a href="{{ url_for('profile.change_password') }}"
                        class="govuk-button govuk-button--secondary"
                        data-module="govuk-button">{{ _("Change password") }}</a>
                {% endif %}
            </div>
            <p class="govuk-body govuk-!-margin-top-6">
                <a href="{{ url_for('main.dashboard') }}" class="govuk-link">{{ _("Back to dashboard") }}</a>
            </p>
        </div>
    </div>
{% endblock %}

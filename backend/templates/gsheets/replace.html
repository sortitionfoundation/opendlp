{% extends "main/view_assembly_base.html" %}
{% block title %}{{ _("Replacements") }} - {{ assembly.title }} - OpenDLP{% endblock %}
{% block assembly_breadcrumbs %}
    <li class="govuk-breadcrumbs__list-item">
        <a class="govuk-breadcrumbs__link"
            href="{{ url_for('main.view_assembly_data', assembly_id=assembly.id) }}">{{ _("Data & Selection") }}</a>
    </li>
    <li class="govuk-breadcrumbs__list-item">{{ _("Replacements") }}</li>
{% endblock %}
{% block assembly_content %}
    <h1 class="govuk-heading-l">{{ _("Replacements for") }} {{ assembly.title }}</h1>
    <p class="govuk-body">{{ _("Run the replacement selection for this assembly using Google Spreadsheet data.") }}</p>
    <div class="govuk-button-group govuk-button-group-mixed govuk-!-margin-top-6">
        {% if not run_record or run_record.has_finished %}
            <form action="{{ url_for('gsheets.start_gsheet_replace_load', assembly_id=assembly.id) }}"
                method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="govuk-button">
                    {% if not run_record %}
                        {{ _("Load Spreadsheet") }}
                    {% else %}
                        {{ _("Reload Spreadsheet") }}
                    {% endif %}
                </button>
            </form>
            <a href="{{ url_for('gsheets.manage_assembly_gsheet_tabs', assembly_id=assembly.id) }}"
                class="govuk-button govuk-button--secondary">{{ _("Manage Generated Tabs") }}</a>
        {% else %}
            <button class="govuk-button" disabled>
                {% if run_record.task_type.value == "load_replacement_gsheet" %}
                    {{ _("Loading Google Spreadsheet") }}
                {% elif run_record.task_type.value == "select_replacement_gsheet" %}
                    {{ _("Selecting %(num)s Replacements with Google Spreadsheet", num=num_to_select) }}
                {% else %}
                    {{ _("Task in Progress...") }}
                {% endif %}
            </button>
        {% endif %}
    </div>
    {# Number to select form - shown when min_select and max_select are present #}
    {% if min_select and max_select %}
        <div id="replacement-selection-form" class="govuk-!-margin-top-6">
            <h2 class="govuk-heading-m">
                {% if num_to_select %}
                    {{ _("Re-Run Replacement Selection") }}
                {% else %}
                    {{ _("Run Replacement Selection") }}
                {% endif %}
            </h2>
            {% if not run_record or run_record.task_type.value != 'select_replacement_gsheet' or run_record.has_finished %}
                <form action="{{ url_for('gsheets.start_gsheet_replace', assembly_id=assembly.id, min_select=min_select, max_select=max_select) }}"
                    method="post"
                    id="replace-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="number_to_select">{{ _("Number of people to select") }}</label>
                        <div id="number-hint" class="govuk-hint">
                            {{ _('Enter a number between %(min)s and %(max)s', min=min_select, max=max_select) }}
                        </div>
                        <input class="govuk-input govuk-input--width-10"
                            id="number_to_select"
                            name="number_to_select"
                            type="number"
                            min="{{ min_select }}"
                            max="{{ max_select }}"
                            {% if num_to_select %} value="{{ num_to_select }}" {% else %} value="{{ min_select }}" {% endif %}
                            required>
                    </div>
                    <button type="submit" class="govuk-button" id="run-replacements-btn">{{ _("Run Replacements") }}</button>
                </form>
            {% endif %}
        </div>
    {% endif %}
    <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
    {% if gsheet %}
        {% include "gsheets/components/view_config_collapsed.html" %}
    {% endif %}
    <div class="govuk-!-margin-top-6 govuk-!-margin-bottom-6">
        {% set progress_url = url_for('gsheets.gsheet_replace_progress', assembly_id=assembly.id, run_id=run_id) if run_id else '' %}
        {% include "gsheets/components/progress.html" %}
    </div>
{% endblock %}
